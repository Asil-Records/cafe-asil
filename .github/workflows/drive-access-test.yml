name: Test Google Drive Access - Service Account

on:
  workflow_dispatch:
    inputs:
      playlist-name:
        description: 'Input to trigger the playlist workflow'
        required: true
        default: 'lofi'
        type: choice
        options:
          - lofi-moments
          - sleepy-cafe
          - study&focus-mixes
          - morning-brew
    

jobs:
  create-session-folders:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare workflow variables
        run: |
          PLAYLIST_NAME="${{ github.event.inputs.playlist-name }}"
          SESSION_DATE=$(date +%Y%m%d)
          TARGET_PATH="tempdrive:music/${PLAYLIST_NAME}/session-${SESSION_DATE}"
          ASSETS_PATH="${TARGET_PATH}/assets"
          echo "TARGET_PATH=${TARGET_PATH}" >> $GITHUB_ENV
          echo "ASSETS_PATH=${ASSETS_PATH}" >> $GITHUB_ENV

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash
          rclone version

      - name: Write Service Account JSON
        run: |
          cat > ./service-account.json <<EOF
          ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}
          EOF

      - name: Create temporary rclone remote
        run: |
          rclone config create tempdrive drive \
            service_account_file=./service-account.json \
            root_folder_id=${{ vars.GDRIVE_SHARED_FOLDER_ID }}

      - name: List contents of shared folder
        run: |
          rclone lsd tempdrive:

      - name: Create session folder (if not exists)
        run: |
          echo "Checking if folder exists: $TARGET_PATH"
    
          if rclone lsd "${TARGET_PATH}" >/dev/null 2>&1; then
          echo "Folder already exists, skipping creation."
          else
          echo "Folder not found, creating..."
          rclone mkdir "${TARGET_PATH}"
          echo "Folder created successfully."
          fi

      - name: Create assets folder (if not exists)
        run: |
          echo "Checking if assets folder exists: ${ASSETS_PATH}"
          if rclone lsd "${ASSETS_PATH}" >/dev/null 2>&1; then
          echo "Assets folder already exists, skipping creation."
          else
          echo "Assets folder not found, creating..."
          rclone mkdir "${ASSETS_PATH}"
          echo "Assets folder created successfully."
          fi
          