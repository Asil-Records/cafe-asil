name: CafÃ© Asil Content Automation

on:
  workflow_dispatch:
    inputs:
      playlist-name:
        description: 'Choose playlist type'
        required: true
        default: 'lofi-moments'
        type: choice
        options:
          - lofi-moments
          - sleepy-cafe
          - morning-brew
      requested-audio-count:
        description: 'Total count of songs to create content'
        required: true
        default: '3'
        type: 'string'
      requested-image-count:
        description: 'Total count of images to pull'
        required: true
        default: '3'
        type: 'string'

jobs:
    content_creation:
        runs-on: ubuntu-latest
        container:
            image: ghcr.io/asil-records/create-session-image:v2
        
        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Write rclone config
              run: |
                mkdir -p ~/.config/rclone
                cat > ~/.config/rclone/rclone.conf <<EOF
                ${{ secrets.RCLONE_CONFIG }}
                EOF
                echo "Config file written."

            - name: Prepare variables
              id: vars
              run: |
                PLAYLIST_NAME="${{ github.event.inputs.playlist-name }}"
                REQUESTED_AUDIO_COUNT="${{ github.event.inputs.requested-audio-count }}"
                REQUESTED_IMAGE_COUNT="${{ github.event.inputs.requested-image-count }}"
                SESSION_DATE=$(date +%Y%m%d)
                REMOTE_BASE="cafe-asil:Asil-Records/cafe-asil"
                REMOTE_RAW_AUDIO="${REMOTE_BASE}/raw_audios/${PLAYLIST_NAME}"
                REMOTE_SESSION_BASE="${REMOTE_BASE}/sessions"
                REMOTE_SESSION_BASE_DIR="${REMOTE_SESSION_BASE}/session_${SESSION_DATE}_${PLAYLIST_NAME}"
                REMOTE_SESSION_AUDIO_DIR="assets/audios"
                REMOTE_SESSION_IMAGE_DIR="assets/images"
                REMOTE_SESSION_MERGED_DIR="merged"

                echo "PLAYLIST_NAME=$PLAYLIST_NAME" >> $GITHUB_ENV
                echo "REQUESTED_AUDIO_COUNT=$REQUESTED_AUDIO_COUNT" >> $GITHUB_ENV
                echo "REQUESTED_IMAGE_COUNT=$REQUESTED_IMAGE_COUNT" >> $GITHUB_ENV
                echo "REMOTE_RAW_AUDIO=$REMOTE_RAW_AUDIO" >> $GITHUB_ENV
                echo "REMOTE_SESSION_BASE=$REMOTE_SESSION_BASE" >> $GITHUB_ENV
                echo "REMOTE_SESSION_BASE_DIR=$REMOTE_SESSION_BASE_DIR" >> $GITHUB_ENV
                echo "REMOTE_SESSION_AUDIO_DIR=$REMOTE_SESSION_AUDIO_DIR" >> $GITHUB_ENV
                echo "REMOTE_SESSION_IMAGE_DIR=$REMOTE_SESSION_IMAGE_DIR" >> $GITHUB_ENV
                echo "REMOTE_SESSION_MERGED_DIR=$REMOTE_SESSION_MERGED_DIR" >> $GITHUB_ENV

                echo "ðŸ”¹ Variables prepared"

            - name: Update script permissions
              run: chmod +x ./scripts/*.sh

            - name: Update session path
              shell: bash
              run: |
                  ./scripts/update_session_path.sh "${REMOTE_SESSION_BASE_DIR}" "${REMOTE_SESSION_BASE}"

            - name: Processing audio files
              shell: bash
              run: |
                ./scripts/process_audios.sh "${PLAYLIST_NAME}" "${REQUESTED_AUDIO_COUNT}" "${SESSION_DIR}"

            - name: Process image files
              shell: bash
              run: |
                ./scripts/process_images.sh "${PLAYLIST_NAME}" "${REQUESTED_IMAGE_COUNT}" "${SESSION_DIR}"

            - name: Prepare merged content
              shell: bash
              run: |
                ./scripts/prepare_merged_content.sh "${SESSION_DIR}"

            - name: Add completion summary
              run: |
                echo "### â˜• CafÃ© Asil **${SESSION_NAME}**" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "- Playlist: **${{ github.event.inputs.playlist-name }}**" >> $GITHUB_STEP_SUMMARY
                echo "- Session Path: **${SESSION_DIR}**" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "Workflow completed successfully ðŸŽµ" >> $GITHUB_STEP_SUMMARY

            

            
              


