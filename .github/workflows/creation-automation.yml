name: CafÃ© Asil Content Automation

on:
  workflow_dispatch:
    inputs:
      playlist-name:
        description: 'Choose playlist type'
        required: true
        default: 'lofi-moments'
        type: choice
        options:
          - lofi-moments
          - sleepy-cafe
          - morning-brew

jobs:
    content_creation:
        runs-on: ubuntu-latest
        container:
            image: ghcr.io/asil-records/create-session-image:v1
        
        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Write rclone config
              run: |
                mkdir -p ~/.config/rclone
                cat > ~/.config/rclone/rclone.conf <<EOF
                ${{ secrets.RCLONE_CONFIG }}
                EOF
                echo "Config file written."

            - name: Prepare variables
              id: vars
              run: |
                PLAYLIST_NAME="${{ github.event.inputs.playlist-name }}"
                SESSION_DATE=$(date +%Y%m%d)
                REMOTE_BASE="cafe-asil:Asil-Records/cafe-asil"
                REMOTE_SESSION_BASE="${REMOTE_BASE}/sessions"
                REMOTE_SESSION_BASE_DIR="${REMOTE_SESSION_BASE}/session_${SESSION_DATE}_${PLAYLIST_NAME}"

                FINAL_REMOTE_DIR="$REMOTE_SESSION_BASE_DIR"
                COUNTER=1

                echo "ðŸ” Checking existing session folders on Drive..."
                # List current session folders once and cache locally
                EXISTING_JSON=$(rclone lsjson "$REMOTE_SESSION_BASE" || echo "[]")
                echo "---- BEGIN EXISTING_JSON ----"
                echo "$EXISTING_JSON"
                echo "---- END EXISTING_JSON ----"

                # Quick helper function
                exists_in_remote() {
                    echo "$EXISTING_JSON" | jq -e --arg name "$(basename "$1")" '.[] | select(.Name == $name)' >/dev/null 2>&1
                }

                # Check if session folder already exists, and if so, increment suffix
                while exists_in_remote "$FINAL_REMOTE_DIR"; do
                    FINAL_REMOTE_DIR="${REMOTE_SESSION_BASE_DIR}_${COUNTER}"
                    COUNTER=$((COUNTER+1))
                done

                echo "SESSION_DIR=$FINAL_REMOTE_DIR" >> $GITHUB_ENV

            - name: Create session folders
              run: |
                rclone mkdir "$SESSION_DIR/assets/audio"
                rclone mkdir "$SESSION_DIR/assets/video"
                rclone mkdir "$SESSION_DIR/merged"
                echo "Session directory created: $SESSION_DIR"
                echo "âœ… Created remote session: $SESSION_DIR" 

